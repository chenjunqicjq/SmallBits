# Redis基础之主从复制

## 实现过程

当在客户端中相服务器发送SLAVEOF  ip  impot  命令，当前服务器就会以命令中的ip的服务器为主服务器，当前服务器为从服务器，从而执行复制主服务器的当前状态。

从服务器在发送SLAVEOF命令后，需要将自己的服务器状态调整到与主服务器状态一致，所以需要像主服务器发送同步命令PSYNC命令。当主服务器收到命令后，将执行完整重同步或者部分重同步。

**完整重同步**：当从服务器第一次向主服务器进行同步时，会调用BGSAVE来创建RDB文件并将其发送给从服务器。

**部分重同步**：当从服务器是在断开链接后重链接后的同步请求，则会检查自身与从服务器中所不一致的数据，将其发送给从服务器即可。

## 部分重同步是实现原理

**复制偏移量**：当主从建立连接后，双方会维护一个复制偏移量，其中计算的就是所执行的命令的长度，每当主服务器执行一条命令后，主服务器的偏移量就会加相应命令的长度，然后将命令发送给从服务器，从服务器街道命令执行后，同样也将偏移量进行增加，保证双方的偏移量一致。

**复制缓冲区**：主服务器维护的复制缓冲区就是一个固定长度的FIFO的队列，当主服务器执行一条命令时，不止发送给从服务器，同时也会保存到缓冲区中作为备份。

**运行ID**：当主从服务器建立连接时，主服务器会将自己的运行ID发送给从服务器，从服务器进行保存，标示自己的主服务器。

当从服务器进行同步请求时，会将运行ID，自己的复制偏移量一并和PSYNC命令一起发送给主服务器，主服务器接受到后，会将运行ID与自身比较，如果发现相同，然后将复制偏移量和自身的偏移量相比，若不相等，则表示从服务器有一部分内容为被接受，从而区缓存区找到相应的命令，然后发送给从服务器。

## PSYNC执行实现

**1.设置ip地址和端口**：首先从服务器会将主服务器的ip和端口号进行保存起来

**2.建立套接字连接**：然后从服务器会先主服务器发送套接字连接请求，如果主服务器不忙时会进行应答；若忙时则会拒接，则从服务器会重新进行套接字连接请求。

**3.ping测试网络**：当建立连接后，从服务器会先进行ping几个数据包来测试网络状况是否良好，如果当前网络状态不佳，或者主服务器正忙，从服务器会断开连接并重写请求套接字连接请求。

**4.身份验证**：若网路状态良好，则从服务器会向主服务器发送作者信息进行验证，主服务器将其信息与自身对照，相同则进行恢复，不同则进行重试

**5.发送从服务器的监听端口号**:从服务器会向主服务器发送自己的监听端口号。

**以上操作则是从服务器建立一个客户端，将自己当作主服务器的客户端来使用。**

6.执行同步（互为服务器，客户端）:执行同步之前，主服务器也会自己建立一个客户端，将从服务器作为自己的服务器。这样做是为了在执行同步时主服务器需要将缓存区的数据发送给从服务器，而发送数据只能在服务器和客户端之间进行。执行同步则分为完整重定向和部分重定向。

**7.命令传播**：当同步执行完后，则只用保持主从的连接，每当主服务器执行一条命令，则向从服务器传送一条命令。

## 心跳检测

当主从建立连接后，从服务器会每隔1秒向主服务器发送确认信息，而主服务器会对请求进行回应。当主服务器超过1秒未收到从服务器的请求时则意味着从服务器已经断开连接。当然，若主服务器的应答因为网络原因丢失，而从服务器接收不到回应。则在下一次的请求中主服务器检查偏移量不同时会进行部分重定向。









































