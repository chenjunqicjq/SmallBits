# Redis基础之数据结构

## 1.简单动态字符串（SDS）

sds使用保存了当前字符串数组的使用长度，空闲空间长度。可以快速的获取当前字符串的长度和空闲空间。它并不以空字符为一段字符串的结束，可以在一个字符串里有空格存在如“i am a boy”。

**避免缓冲区溢出**：在c语言中的字符串中当两个字符串存储在一起时，当第一个字符串进行拼接操作时可能会对字符串2进行覆盖，导致字符串2数据改变。而sds中则会在拼接时查看空闲空间是否足够，当不足够时会进行内存分配可以避免该情况的发生。

**空间预分配**：当一个sds中需要进行拼接字符串时，检查发现空闲空间不足，则会进行扩充。扩充规则：

当拼接后的字符串的大小小于30M时，扩充的大小为拼接后的长度的2倍。即扩充后使用空间与空闲空间大小相等。如字符串原本长度为4，新拼接的字符串长度为5，则扩充后的字符串总空间为使用空间9+空闲空间9+结尾空间1=19。

**空间惰释放**：当一个字符串进行删除某些字符后，空出来的空间并不会被释放，而是依然被该字符串拥有。只是改变了使用空间和空闲空间的值。当下一次对该字符串拼接时直接可用，不必再次分配空间。

## 2.链表

Redis中的链表就是一个双向不循环链表，只是保持了对链表的表头节点，表尾节点的引用，并且记录链表长度。

## 3.字典

字典的实现类似Java中的HashMap的实现也是数组链表的方式。

字典保持了两个哈希表的引用，其中一个用来日常存储键值对，拎一个在进行rehash时作为容器使用。

哈希表跟HashMap类似，也是数组加链表的结构，使用链地址法来解决哈希冲突。

**rehash**:当需要进行rehash时，会对第二个哈希表进行空间分配，扩充时的大小为比第一个哈希表的键值对个数的2倍大的最近的2的n次方。例如当前的键值对个数为7，则7*2=14，则比14大的2的n次方为16，所以扩充空间为16。然后使用一个计数器记录哈希表移动到第二个哈希表的键值对个数，当该计数器大小等于键值对个数时表示全部移动完成，将该计数器置为-1.先计算键值对的hash值，然后与第二个哈希表的大小进行相与，得到桶数，然后将其从第一个哈希表移动到第二个哈希表中，当地址冲突时使用头插法进行链表挂链。当键值对全都移动到第二个哈希表中后，删除空闲的第一个哈希表，将新的哈希表作为第一个哈希表，重新创建一个哈希表作为第二个哈希表。

**渐进rehash**：当字典中的键值对很多时，进行rehash操作可能导致一段时间内停止服务。所以采用渐进式的，一次移动一部分，一次一次的移动。当在rehash过程中需要查找一个键值对时会先去第一个哈希表中查找，没有再到第二个哈希表中查找。而添加元素时则会直接加入第二个哈希表中。

## 4.跳跃表

当一个链表的长度很长时，需要查询一个元素，则需要遍历一遍该链表，效率实在太慢。所以可以想，将一些元素抽离出来，形成一个新链表，新链表两个节点之间的距离是原来链表的一段区间，可以实现每次都可以走多个节点，减少遍历节点。然后一次一直抽离，一直形成新的链表。

Redis中的跳表其实是最原始的链表是个双向链表，持有双向链表的头节点和尾节点，可以快速的从最近的地方发起遍历。

**查找**：从高层开始，判断当前节点的下一个节点是否小于查找值，小于则直接跳跃到下一节点，当下一节点大于查找值，则表示查找节点在当前节点与下一节点区间，则判断当前节点是都有下一层的节点，如果没有，则返回下一节点。若果有，则进入下一层，则接着重复刚才的步骤，知道找到为止。其实类似与二分查找，只是用链表实现。

**插入**：插入一个元素，则随机生成层数，将其加入该层的节点中，则在该层的下面的层数里都添加进去。

**删除**：同插入元素一样，找到该元素所在的层次，删除该层及以下层里的该元素。

## 5.整数集合

当一个集合中都是整数时，可以使用整数集合。其中支持多种长度的数据，如8,16,64位等长度。

**升级**：当新添加的元素的长度大于当前集合里存储的元素的长度时，会对集合里的数据都进行类型长度变化，内存也进行扩展，将数据移动到扩展好的空间后才将新元素加入集合中。如原来集合中的长度都是8位的，有三个元素，则内存空间为8*3=24bit；新加入一个元素为16，则先将空间扩大为16 *4=64bit,然后将第三的元素放入第32--47的空间中，第二个元素放入第16-31的空间中，第一个元素放入第0-15空间中，最后才会将需要加入的元素放入第48-63空间中。

## 6.压缩列表

当一个集合中的元素都是整数或者小的字符串时，会使用压缩列表来存储数据。压缩列表中保存了前一个节点的长度，当前节点的数据类型和长度，当前节点的值。因为保存了前一个节点的长度，所以可以从尾节点往头节点进行遍历。





















































