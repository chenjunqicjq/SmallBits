# Redis基础之Sentinel

Sentinel是Redis的高可用解决方案：通过一个或多个的Sentinel实例组成的Sentinel系统，可以进行监视一个或多个主服务器的运行状态，以及这些主服务器的从服务器，当监视到某个主服务器断线之后，会从该主服务器中的从服务器中选举一个从服务器作为新的主服务器，将其他从服务器的主服务器对象修改为新的主服务器。以实现故障转移。

**Sentinel服务器**：其本质就是一个运行在特殊模式下的Redis服务器，只不过在初始化时并不载入RDB文件或AOF文件，而是使用自己的专用代码导致普通服务器里的很多命令并不可用。

**主服务器**：就是一个普通的服务器，当设定为主服务器时则为主服务器。

在一个Sentinel服务器中保存着其监视的所有主服务器及其所有的从服务器的信息，如ip和端口号。Sentinel服务器会与每一个服务器建立命令连接和订阅连接，命令连接用于向其监视的服务器发送命令请求，而订阅连接则用来接受服务器发送的消息。

一个服务器可能被多个Sentinel服务器进行监视，则它将与每个Sentinel服务器建立命令连接和订阅连接，而Sentinel和Sentinel之间仅仅之需要进行命令连接。

Sentinel会每个几秒向其监视的服务器发送命令，其中包括了对象服务器的ip,端口号，Sentinel的运行id和配置纪元等，而服务器收到后会回复其Sentinel的运行id，ip,端口号，配置纪元，然后Sentinel根据接受到的回复进行更新服务器字典。

当Sentinel一段时间内接受不到主服务器的回复后，就会将其判定为主观下线，当然还需要询问其他同样监视该服务器的Sentinel来判断是否下线，因为每个Sentinel设定的判定下线时间不同，所以需要满足其他Sentinel都判断下线，才能将该主服务器状态修改为客观下线。

## 故障转移

**1.选举领头Sentinel**：当判定一个主服务器客观下线，则需要选举一个领头Sentinel来执行故障转移操作。当第一个发现主服务器的状态改变为客观下线的Sentinel会向其他Sentinel发送消息，里面包含子自己的运行Id，希望对方将自己选举为领头，目标Sentinel将收到的第一份通知中的id对应的Sentinel选举为领头，当某一个Sentinel获得了半数以上的票数后，当选为领头。如果没有一个能符合票数，则将在一段时间后进行重新选举。

**2.选出替代主服务器的从服务器：**领头Sentinel会将下线的主服务器中的所有从服务器添加到列表中，删除一段时间没有进行回复的从服务器（确保剩下的从服务器是出于连接状态的），删除最近时间没有进行回复的，然后根据优先级进行排序，若优先级相同，则会复制偏移量来进行排序（复制偏移量越大，说明复制的内容越多，数据越新）。

**3.更改从服务器的复制对象：**在确定了新的主服务器后，将其设定为新主服务器，然后将其他从服务器的复制对象修改为新的主服务器，可以实现数据的一致性。

**4.将旧的主服务器变为新的从服务器：**最后将旧的主服务器更改为新的服务器的从服务器，当重新连接上后作为一个从服务器使用。





































